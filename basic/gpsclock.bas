
10 BAUD 1, 9 : REM set 9600 baud for GPS module

20 REM turn off everything but GPGGA
30 X$="$PMTK314,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0*29"
40 GOSUB 7000

100 GOSUB 5000
110 IF (ST=14) THEN PRINT "time packet "; H; " "; M; " "; S
120 GOTO 100

5000 REM A simple parser for parsing GPGGA packets
5001 REM Look for $,G,P,G,G,A,Comma, then read HHMMSS
5005 IF (RSER(1)=0) THEN RETURN : REM return if no character ready
5010 C=ISER(1) : REM read a character 
5011 REM PRINT "state "; ST; " char "; C
5012 IF ST=2 GOTO 5200
5013 IF ST=3 GOTO 5300
5014 IF ST=4 GOTO 5400
5015 IF ST=5 GOTO 5500
5016 IF ST=6 GOTO 5600
5017 IF ST=7 GOTO 5700
5018 IF ST=8 GOTO 5800
5019 IF ST=9 GOTO 5900
5020 IF ST=10 GOTO 6000
5021 IF ST=11 GOTO 6100
5022 IF ST=12 GOTO 6200
5023 IF ST=13 GOTO 6300
5024 GOTO 5100

5100 IF (C=36) THEN ST=2 : RETURN : REM $
5110 ST=1
5120 RETURN

5200 IF (C=71) THEN ST=3 : RETURN : REM G 
5210 ST=1
5220 RETURN

5300 IF (C=80) THEN ST=4 : RETURN : REM P
5310 ST=1
5320 RETURN

5400 IF (C=71) THEN ST=5 : RETURN : REM G
5410 ST=1
5420 RETURN

5500 IF (C=71) THEN ST=6 : RETURN : REM G
5510 ST=1
5520 RETURN

5600 IF (C=65) THEN ST=7 : RETURN : REM A
5610 ST=1
5620 RETURN

5700 IF (C=44) THEN ST=8 : RETURN : REM ,
5710 ST=1
5720 RETURN

5800 IF (C<48) OR (C>57) THEN ST=1 : RETURN
5810 H=(C-48)*10 
5820 ST=9
5830 RETURN

5900 IF (C<48) OR (C>57) THEN ST=1 : RETURN
5910 H=H+(C-48)
5920 ST=10
5930 RETURN

6000 IF (C<48) OR (C>57) THEN ST=1 : RETURN
6010 M=(C-48)*10
6020 ST=11
6030 RETURN

6100 IF (C<48) OR (C>57) THEN ST=1 : RETURN
6110 M=M+(C-48)
6120 ST=12
6130 RETURN

6200 IF (C<48) OR (C>57) THEN ST=1 : RETURN
6210 S=(C-48)*10
6220 ST=13
6230 RETURN

6300 IF (C<48) OR (C>57) THEN ST=1 : RETURN 
6310 S=S+(C-48)
6320 ST=14
6330 RETURN 

7000 REM output string to GPS
7010 FOR I=1 to LEN(X$)
7020 OSER 1, ASC(MID$(X$, I, 1))
7030 NEXT I
7040 OSER 1, 13
7050 OSER 1, 10
7060 RETURN
